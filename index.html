<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kotha Massage</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wa-header-bg: #005c97; /* A deep, rich blue */
            --wa-accent-blue: #34B7F1; /* A vibrant, modern blue for accents */
            --wa-message-out-bg: #e1f6fb; /* A very light blue for sent messages */
            --wa-message-in-bg: #ffffff;
            --wa-app-bg: #f0f2f5; /* Light grey background, common in modern apps */
            --wa-chat-bg: #e5ddd5; /* Classic WhatsApp pattern background color */
            --wa-icon-color: #f0f2f5;
            --wa-text-primary: #111b21;
            --wa-text-secondary: #667781;
            --wa-border-color: #e9edef;
            --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069; /* Kept a green shade for buttons for familiarity */
            --wa-link-color: #00a8e8;
            --wa-shadow: rgba(17, 27, 33, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #d1d7db; /* The grey area outside the app */
        }

        body {
            color: var(--wa-text-primary);
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        
        /* --- General UI Elements --- */
        .icon-btn {
            background: none;
            border: none;
            color: var(--wa-icon-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: relative;
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        .text-icon-btn {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid var(--wa-border-color);
            background-color: transparent;
            color: var(--wa-header-bg);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .text-icon-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .text-icon-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--wa-header-bg);
        }
        .text-icon-btn.primary {
            background-color: var(--wa-header-bg);
            color: white;
            border-color: var(--wa-header-bg);
        }
        .text-icon-btn.primary svg {
            fill: white;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            max-height: 950px;
            background-color: var(--wa-app-bg);
            box-shadow: 0 12px 28px 0 var(--wa-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            border-radius: 8px;
        }

        .view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }

        .page-header {
             width: 100%;
             padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--wa-header-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
            color: var(--wa-icon-color);
        }
        .page-title {
            font-size: 20px;
            font-weight: 500;
        }

        /* --- NEW: Loading View --- */
        #loading-view {
            justify-content: center;
            background-color: #fff;
        }
        .loader {
            border: 4px solid var(--wa-app-bg);
            border-top: 4px solid var(--wa-header-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Auth View --- */
        #auth-view { justify-content: center; padding: 40px 20px; }
        .app-title { font-size: 36px; font-weight: 700; color: var(--wa-header-bg); margin-bottom: 40px; text-align: center; }
        .auth-form { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 16px; }
        .auth-form input, .auth-form select { border-radius: 8px; border: 1px solid #ccc; background-color: #fff; color: var(--wa-text-primary); padding: 14px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-form input:focus, .auth-form select:focus { outline: none; border-color: var(--wa-header-bg); box-shadow: 0 0 0 2px rgba(0, 92, 151, 0.2); }
        .auth-form button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 14px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .auth-form button:hover { background-color: #004c7a; }
        .form-switch-text { color: var(--wa-text-secondary); font-size: 14px; text-align: center; margin-top: 10px; }
        .form-switch-text a { color: var(--wa-link-color); text-decoration: none; cursor: pointer; font-weight: 500; }
        .error-message { color: #d93025; font-size: 13px; text-align: center; min-height: 20px; }

        /* --- Main View --- */
        #main-view { display: none; }
        header.main-header { width: 100%; background-color: var(--wa-header-bg); padding: 10px 15px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 5; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 500; color: var(--wa-icon-color); }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .badge { position: absolute; top: -2px; right: -4px; background-color: #d93025; color: white; border-radius: 10px; font-size: 11px; padding: 2px 6px; font-weight: 500; display: none; border: 1px solid var(--wa-header-bg); }
        main { width: 100%; flex-grow: 1; overflow-y: auto; background-color: #fff; }
        .list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; background-color: #fff; border-bottom: 1px solid var(--wa-border-color); transition: background-color 0.2s; }
        .list-item:hover { background-color: var(--wa-app-bg); }
        .list-item:last-child { border-bottom: none; }
        .list-item-profile-img { margin-right: 15px; width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background-color: #ccc; }
        .list-item-details { flex-grow: 1; }
        .list-item-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .list-item-subtext { font-size: 14px; color: var(--wa-text-secondary); }
        .list-item-actions { display: flex; gap: 10px; }
        .list-item-actions button { background-color: var(--wa-accent-blue); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .list-item-actions button.reject { background-color: var(--wa-text-secondary); }

        /* --- Notification View --- */
        #notifications-view main { padding-top: 10px; }
        .notification-section h3 { padding: 10px 15px; font-size: 16px; color: var(--wa-header-bg); background-color: var(--wa-app-bg); border-bottom: 1px solid var(--wa-border-color); }
        .notification-item {
            display: flex;
            gap: 10px; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--wa-border-color);
            cursor: pointer;
        }
        .notification-item:hover { background-color: var(--wa-app-bg); }
        .notification-item.unread {
            background-color: #e8f0fe; /* A light blue to indicate unread */
        }


        /* --- Chat View --- */
        #chat-view { display: none; position: absolute; top: 0; left: 0; z-index: 10; background-color: var(--wa-chat-bg); background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3E%3C/g%3E%3C/svg%3E"); }
        header.chat-header { width: 100%; padding: 8px 10px; display: flex; align-items: center; gap: 10px; background-color: var(--wa-header-bg); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex-shrink: 0; z-index: 1; }
        header.chat-header .icon-btn { color: var(--wa-icon-color); }
        #chat-header-info { text-align: left; flex-grow: 1; color: var(--wa-icon-color); cursor: pointer;}
        #chat-header-name { font-weight: 500; font-size: 17px; line-height: 1.2; }
        #chat-header-subtext { font-size: 12px; color: #f0f2f5e0; line-height: 1.2; }
        #chat-header-img { width: 40px; height: 40px; background-color: #ccc; border-radius: 50%; object-fit: cover; cursor: pointer;}
        .chat-header-actions { display: flex; align-items: center; gap: 5px; }
        .dropdown-menu { display: none; position: absolute; top: 50px; right: 10px; background-color: white; border-radius: 8px; box-shadow: 0 4px 12px var(--wa-shadow); z-index: 15; overflow: hidden; width: 180px; }
        .dropdown-menu button { background: none; border: none; padding: 12px 16px; width: 100%; text-align: left; cursor: pointer; font-size: 15px; color: var(--wa-text-primary); }
        .dropdown-menu button:hover { background-color: var(--wa-app-bg); }
        #chat-messages { flex-grow: 1; width: 100%; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; }
        #chat-messages a { color: var(--wa-link-color); text-decoration: underline; }
        .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; margin-bottom: 2px; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 1px var(--wa-shadow); position: relative; }
        .message-bubble img { max-width: 100%; border-radius: 8px; display: block; cursor: pointer; }
        .message-sent { background-color: var(--wa-message-out-bg); align-self: flex-end; border-bottom-right-radius: 0; }
        .message-received { background-color: var(--wa-message-in-bg); align-self: flex-start; border-bottom-left-radius: 0; }
        .message-meta { text-align: right; margin-top: 4px; font-size: 11px; color: var(--wa-text-secondary); }
        #chat-input-container { width: 100%; padding: 8px 12px; display: flex; gap: 10px; background-color: var(--wa-app-bg); align-items: flex-end; }
        #chat-input { flex-grow: 1; border: none; background-color: #fff; color: var(--wa-text-primary); padding: 12px 18px; border-radius: 22px; font-family: 'Roboto', sans-serif; font-size: 15px; max-height: 100px; resize: none; }
        #chat-input:focus { outline: none; }
        #chat-send-btn { background: var(--wa-accent-blue); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-bottom: 2px; transition: background-color: 0.2s; }
        #chat-send-btn:hover { background-color: #2aa3e0; }
        #chat-send-btn svg { width: 24px; height: 24px; fill: white; margin-left: 2px; }
        #chat-attach-btn {
            color: var(--wa-text-secondary);
            background-color: white;
            width: 44px; height: 44px;
            border-radius: 50%;
            margin-bottom: 2px;
            flex-shrink: 0;
            box-shadow: 0 1px 1px var(--wa-shadow);
        }
        #chat-attach-btn:hover { background-color: #f0f0f0; }
        #chat-attach-btn svg { fill: var(--wa-text-secondary); }


        /* --- Call Views --- */
        .call-view { display: none; position: absolute; top: 0; left: 0; z-index: 20; background-color: #222; justify-content: center; align-items: center; }
        #video-call-view { background-color: black; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #local-video { width: 100px; height: 140px; position: absolute; bottom: 120px; right: 20px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 10px; cursor: move; object-fit: cover; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .call-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 60px 20px 50px; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6), transparent 40%, transparent 60%, rgba(0, 0, 0, 0.7)); }
        .caller-info { text-align: center; color: white; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
        .caller-info .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px; }
        .caller-info .name { font-size: 28px; font-weight: 500; margin-top: 10px; }
        .caller-info .status { font-size: 16px; color: #ccc; margin-top: 5px; }
        .call-controls { display: flex; gap: 30px; }
        .call-controls button { width: 70px; height: 70px; border-radius: 50%; border: none; color: white; font-family: 'Roboto', sans-serif; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .end-call-btn { background-color: #e91e63; }
        .accept-call-btn { background-color: #4CAF50; }

        /* --- Modals --- */
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 30; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .modal-content h2 { text-align: center; color: var(--wa-header-bg); font-weight: 500; margin-bottom: 10px; }
        .modal-content label { font-weight: 500; margin-top: 5px; }
        .modal-content select, .modal-content textarea, .modal-content input[type="date"] {
            border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); 
            color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; 
            font-size: 16px; width: 100%;
        }
        .modal-content input[type="text"], .modal-content input[type="password"] { border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; }
        .modal-content button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 12px 20px; cursor: pointer; width: 100%; }
        .modal-content button.secondary { background-color: var(--wa-text-secondary); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        #incoming-call-modal .caller-info { color: var(--wa-text-primary); text-shadow: none; padding-bottom: 20px; }
        .image-upload-label { cursor: pointer; padding: 12px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; color: var(--wa-text-secondary); transition: all 0.2s; }
        .image-upload-label:hover { border-color: var(--wa-header-bg); background-color: #f8f8f8; }
        #qr-code-display { padding: 20px; display: flex; justify-content: center; align-items: center; }
        #image-preview-display img { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        
        /* --- Profile View --- */
        #profile-view main, #user-profile-view main { width: 100%; padding: 0; }
        #profile-info-display, #user-profile-info-display { text-align: center; padding-bottom: 20px; position: relative; }
        .profile-cover-photo { width: 100%; height: 160px; object-fit: cover; background-color: #ccc; }
        .profile-main-info { padding: 0 20px; margin-top: -50px; position: relative; z-index: 2; }
        #profile-info-display img.profile-img, #user-profile-info-display img.profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; }
        #profile-info-display .name, #user-profile-info-display .name { font-size: 22px; font-weight: 500; margin-top: 5px; }
        #profile-info-display .jgId, #user-profile-info-display .jgId { font-size: 14px; color: var(--wa-text-secondary); }
        
        #profile-options { display: flex; flex-direction: column; gap: 5px; padding: 0 20px 20px; }
        #profile-edit-form { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; padding: 0 20px 20px; }
        #blocked-users-section { margin-top: 25px; padding: 0 20px 20px; }
        #blocked-users-section h3 { padding-bottom: 10px; font-weight: 500; color: var(--wa-header-bg); }
        #logout-btn { background-color: #d93025; margin: 0 20px 20px; width: calc(100% - 40px);}
        #blocked-users-list .list-item { background-color: transparent; }
        #blocked-users-list .list-item-actions button { background-color: var(--wa-accent-blue); font-size: 12px; padding: 6px 10px; }
        
        #profile-stats, #user-profile-stats {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px 0;
            border-top: 1px solid var(--wa-border-color);
             border-bottom: 1px solid var(--wa-border-color);
        }
        .stat-item {
            text-align: center;
        }
        .stat-item span {
            display: block;
        }
        .stat-item span:first-child {
            font-size: 20px;
            font-weight: 700;
            color: var(--wa-header-bg);
        }
        .stat-item span:last-child {
            font-size: 14px;
            color: var(--wa-text-secondary);
        }
        .blue-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* --- QR Scanner View --- */
        #qr-scanner-view { background-color: #000; }
        #qr-reader { width: 100%; max-width: 500px; }

        /* USER PROFILE VIEW SPECIFIC */
        #user-profile-actions {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* NEW: Post Image View Modal */
        #post-image-view-modal .modal-content {
            padding: 10px;
        }
        #post-image-view-modal img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        #post-image-view-modal button {
            width: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- NEW: Loading View as the default -->
        <div id="loading-view" class="view">
            <div class="loader"></div>
        </div>

        <div id="auth-view" class="view" style="display: none;">
            <h1 class="app-title">Kotha Massage</h1>
            <form id="login-form" class="auth-form">
                <div id="login-error" class="error-message"></div>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Log In</button>
                <p class="form-switch-text">Don't have an account? <a id="show-signup">Sign up</a></p>
            </form>
            <form id="signup-form" class="auth-form" style="display: none;">
                <div id="signup-error" class="error-message"></div>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p class="form-switch-text">Already have an account? <a id="show-login">Log in</a></p>
            </form>
        </div>

        <div id="main-view" class="view">
            <header class="main-header">
                <div class="header-top">
                    <span class="header-title">Kotha Massage</span>
                    <div class="header-actions">
                         <button id="notification-btn" class="icon-btn" title="Notifications">
                            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                            <span id="notification-badge" class="badge"></span>
                        </button>
                        <button id="add-friend-btn" class="icon-btn" title="Add Friend">
                            <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                        </button>
                        <button id="menu-btn" class="icon-btn" title="Profile & Settings" style="padding: 0;">
                            <img id="header-profile-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f0f2f5'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        </button>
                    </div>
                </div>
            </header>
        
            <main id="main-content">
                <div id="contact-list"></div>
            </main>
        </div>

        <div id="notifications-view" class="view" style="display: none;">
             <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Notifications</span>
             </header>
            <main>
                <div class="notification-section">
                    <h3>Friend Requests</h3>
                    <div id="friend-requests-list"></div>
                </div>
                 <div class="notification-section">
                     <h3>Call History</h3>
                    <div id="call-logs-list"></div>
                </div>
            </main>
        </div>

        <div id="profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Profile</span>
            </header>
            <main>
                <div id="profile-info-display">
                    <img class="profile-cover-photo" alt="Cover Photo">
                    <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                        <div class="jgId"></div>
                    </div>
                </div>
                <div id="profile-stats">
                    <div class="stat-item">
                        <span id="profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>

                <div id="profile-options">
                     <button id="show-qr-btn" class="text-icon-btn primary">
                        <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>My Profile QR</span>
                    </button>
                    <button id="request-badge-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 12.5c0-1.28-.21-2.5-.6-3.63l-1.32.76c.28.89.42 1.83.42 2.87s-.14 1.98-.42 2.87l1.32.76c.39-1.13.6-2.35.6-3.63zm-2.48-5.32c-.52-.9-1.16-1.72-1.9-2.43l-1.13 1.13c.59.57 1.1 1.25 1.52 2.01l1.51-.71zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1.04 11.45l-2.83-2.83.71-.71 2.12 2.12 4.95-4.95.71.71-5.66 5.66zM4.98 7.18l1.51.71c.42-.76.93-1.44 1.52-2.01L6.88 4.75c-.74.71-1.38 1.53-1.9 2.43zM2.1 8.87l1.32-.76C3.02 9.22 2.9 10.16 2.9 11.1s.12 1.88.33 2.78l-1.32-.76C1.51 12.04 1.3 11.09 1.3 10.1s.21-1.94.6-2.87zm16.92 7.66l-1.51-.71c-.42.76-.93 1.44-1.52 2.01l1.13 1.13c.74-.71 1.38-1.53 1.9-2.43z"></path></svg>
                        <span>Request Badge</span>
                    </button>
                     <button id="edit-profile-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        <span>Edit My Profile</span>
                     </button>
                </div>

                <div id="profile-edit-form" style="display:none;">
                    <input type="text" id="edit-profile-name">
                     <input type="file" id="edit-profile-image" accept="image/*" style="display:none;">
                    <label for="edit-profile-image" class="image-upload-label">Change Picture</label>
                    <input type="file" id="edit-profile-cover" accept="image/*" style="display:none;">
                    <label for="edit-profile-cover" class="image-upload-label">Change Cover Photo</label>
                    <button id="save-profile-changes-btn" class="text-icon-btn primary" style="margin-top: 10px;">Save Changes</button>
                </div>

                <div id="blocked-users-section">
                     <h3>Blocked Users</h3>
                    <div id="blocked-users-list" style="max-height: 120px; overflow-y: auto;"></div>
                </div>
                
                <button id="logout-btn">Logout</button>
            </main>
        </div>
        
        <!-- USER PROFILE VIEW -->
        <div id="user-profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span id="user-profile-page-title" class="page-title">Profile</span>
            </header>
            <main>
                <div id="user-profile-info-display">
                     <img class="profile-cover-photo" alt="Cover Photo">
                     <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                     </div>
                </div>
                <div id="user-profile-stats">
                     <div class="stat-item">
                        <span id="user-profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>
                <div id="user-profile-actions">
                    <button id="follow-user-btn" class="text-icon-btn primary">
                        <!-- Content will be set by JS -->
                    </button>
                    <button id="user-profile-show-qr-btn" class="text-icon-btn">
                         <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>Show QR Code</span>
                    </button>
                </div>
                <h3 style="padding: 15px 20px 5px; font-weight: 500; color: var(--wa-header-bg); border-top: 8px solid var(--wa-app-bg);">Posts</h3>
                <div id="user-profile-posts-list" style="width:100%;"></div>
            </main>
        </div>


        <div id="qr-scanner-view" class="view" style="display: none;">
             <header class="page-header">
                  <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Scan QR Code</span>
             </header>
             <main style="justify-content: center; align-items:center; background: #333;">
                <div id="qr-reader"></div>
            </main>
        </div>
        
        <div id="chat-view" class="view">
            <header class="chat-header">
                <button class="back-btn icon-btn">
                     <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <img id="chat-header-img" alt="Profile Pic">
                <div id="chat-header-info">
                    <div id="chat-header-name"></div>
                     <div id="chat-header-subtext"></div>
                </div>
                <div class="chat-header-actions">
                    <button id="voice-call-btn" class="icon-btn" title="Voice Call">
                        <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></svg>
                    </button>
                    <button id="video-call-btn" class="icon-btn" title="Video Call">
                        <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"></path></svg>
                    </button>
                    <button id="chat-more-btn" class="icon-btn" title="More options">
                        <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                    </button>
                </div>
            </header>

            <div id="chat-options-menu" class="dropdown-menu">
                <button id="view-profile-btn">View Profile</button>
                <button id="delete-friend-btn">Delete Friend</button>
                <button id="block-user-btn">Block User</button>
            </div>

            <div id="chat-messages"></div>
            <div id="chat-input-container">
                <button id="chat-attach-btn" class="icon-btn" title="Attach Image">
                    <svg viewBox="0 0 24 24"><path d="M21.58 16.09l-1.09-1.09c-.39-.39-1.02-.39-1.41 0l-4.34 4.34c-1.95 1.95-5.12 1.95-7.07 0s-1.95-5.12 0-7.07l7.12-7.12c.98-.98 2.56-.98 3.54 0 .98.98.98 2.56 0 3.54l-5.71 5.71c-.39.39-1.02.39-1.41 0s-.39-1.02 0-1.41l4.29-4.29c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41L12 16.17c-1.17 1.17-3.07 1.17-4.24 0s-1.17-3.07 0-4.24l5.71-5.71c1.76-1.76 4.61-1.76 6.36 0s1.76 4.61 0 6.36l-7.12 7.12c-2.73 2.73-7.17 2.73-9.9 0s-2.73-7.17 0-9.9l4.34-4.34c.39-.39 1.02-.39 1.41 0l1.09 1.09c.39.39.39 1.02 0 1.41l-4.34 4.34c-1.95 1.95-1.95 5.12 0 7.07s5.12 1.95 7.07 0l7.12-7.12c.98-.98.98-2.56 0-3.54s-2.56-.98-3.54 0l-5.71 5.71c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l4.29-4.29c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0L13.4 14.76c-1.17-1.17-1.17-3.07 0-4.24s3.07-1.17 4.24 0l5.71 5.71c.98.98 2.56.98 3.54 0 .98-.98.98-2.56 0-3.54l-1.09-1.09c-.38-.39-1.02-.39-1.41 0z"></path></svg>
                </button>
                 <input type="file" id="chat-image-input" accept="image/*" style="display: none;">
                
                <textarea id="chat-input" placeholder="Message" rows="1"></textarea>
                <button id="chat-send-btn">
                     <svg viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
        
        <div id="video-call-view" class="view call-view">
            <video id="remote-video" autoplay playsinline></video>
             <video id="local-video" autoplay playsinline muted></video>
            <div class="call-overlay"> <div id="video-caller-info" class="caller-info"> <img class="profile-img" alt="Caller"> <div class="name"></div> <div class="status"></div> </div> <div class="call-controls"> <button id="end-video-call-btn" class="end-call-btn"> <svg fill="white" viewBox="0 0 24 24" width="36" height="36"><path d="M23.64 17.3c-1.18-1.18-2.5-2.13-4-2.81-1.5-.68-3.13-1.03-4.83-1.03-1.7 0-3.33.35-4.83 1.03-1.5.68-2.82 1.63-4 2.81-.38.38-.85.57-1.32.57-.47 0-.94-.19-1.32-.57L2 16c-.75-.75-.75-1.97 0-2.72 1.93-1.93 4.2-3.41 6.67-4.33C10.13 8.35 11.83 8 13.5 8s3.37.35 4.83.95c2.47.92 4.74 2.4 6.67 4.33.75.75.75 1.97 0 2.72l-1.36 1.36c-.38.38-.85.57-1.32.57-.47 0-.94-.19-1.32-.57z"></path></svg> </button> </div> </div>
        </div>
        <div id="voice-call-view" class="view call-view">
             <audio id="remote-audio" autoplay playsinline></audio>
             <div class="call-overlay"> <div id="voice-caller-info" class="caller-info"> <img class="profile-img" alt="Caller"> <div class="name"></div> <div class="status"></div> </div> <div class="call-controls"> <button id="end-voice-call-btn" class="end-call-btn"> <svg fill="white" viewBox="0 0 24 24" width="36" height="36"><path d="M23.64 17.3c-1.18-1.18-2.5-2.13-4-2.81-1.5-.68-3.13-1.03-4.83-1.03-1.7 0-3.33.35-4.83 1.03-1.5.68-2.82 1.63-4 2.81-.38.38-.85.57-1.32.57-.47 0-.94-.19-1.32-.57L2 16c-.75-.75-.75-1.97 0-2.72 1.93-1.93 4.2-3.41 6.67-4.33C10.13 8.35 11.83 8 13.5 8s3.37.35 4.83.95c2.47.92 4.74 2.4 6.67 4.33.75.75.75 1.97 0 2.72l-1.36 1.36c-.38.38-.85.57-1.32.57-.47 0-.94-.19-1.32-.57z"></path></svg> </button> </div> </div>
        </div>

        <div id="profile-setup-modal" class="modal"> 
            <div class="modal-content" style="gap: 10px;"> 
                <h2>Set up your Profile</h2> 
                <input type="text" id="profile-name-input" placeholder="Your Name" required> 
                <select id="profile-gender-select" required>
                    <option value="" disabled selected>Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="profile-dob-input" required>
                <input type="file" id="profile-image-input" accept="image/*" style="display: none;"> 
                <label for="profile-image-input" class="image-upload-label">Upload Profile Picture (Optional)</label> 
                <input type="file" id="profile-cover-input" accept="image/*" style="display: none;"> 
                <label for="profile-cover-input" class="image-upload-label">Upload Cover Photo (Optional)</label> 
                <button id="save-profile-btn">Save Profile</button> 
            </div> 
        </div>

        <div id="add-friend-modal" class="modal"> <div class="modal-content"> <h2>Add Friend</h2> <p>Enter your friend's App ID (e.g., jg-1234)</p> <div style="display:flex; gap:10px; align-items:center;"> <input type="text" id="add-friend-id-input" placeholder="jg-xxxx" style="flex-grow:1;"> <button id="scan-qr-btn" class="icon-btn" title="Scan QR Code" style="color: var(--wa-header-bg); flex-shrink:0; width:44px; height:44px; background-color: var(--wa-app-bg);"><svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg></button> </div> <div class="modal-actions"> <button id="close-add-friend-modal-btn" class="secondary">Cancel</button> <button id="send-friend-request-btn">Send Request</button> </div> </div> </div>
        <div id="incoming-call-modal" class="modal"> <div class="modal-content"> <h2>Incoming Call</h2> <div id="incoming-caller-info" class="caller-info"> <img class="profile-img" alt="Caller"> <div class="name"></div> </div> <div class="modal-actions" style="justify-content:space-around; padding: 10px 0;"> <button id="reject-call-btn" class="end-call-btn">Reject</button> <button id="accept-call-btn" class="accept-call-btn">Accept</button> </div> </div> </div>
        <div id="qr-code-modal" class="modal"> <div class="modal-content"> <h2>Scan this Code</h2> <div id="qr-code-display"></div> <p style="text-align:center; font-size:16px; font-weight:500;" id="qr-code-text"></p> <button id="close-qr-modal-btn" class="secondary">Close</button> </div> </div>
        <div id="exit-confirm-modal" class="modal"> <div class="modal-content"> <h2>Exit App?</h2> <p style="text-align:center;">Are you sure you want to exit?</p> <div class="modal-actions" style="justify-content:space-around;"> <button id="exit-no-btn" class="secondary">No</button> <button id="exit-yes-btn">Yes</button> </div> </div> </div>
        <div id="image-preview-modal" class="modal">
            <div class="modal-content">
                <h2>Preview Image</h2>
                <div id="image-preview-display" style="text-align: center; margin: 10px 0;"></div>
                <div class="modal-actions">
                    <button id="cancel-image-send-btn" class="secondary">Cancel</button>
                    <button id="confirm-image-send-btn">Send</button>
                </div>
            </div>
        </div>

        <div id="post-image-view-modal" class="modal">
            <div class="modal-content">
                <img id="post-image-view-src" src="" alt="Post Image">
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button id="close-post-image-view-btn" class="secondary">Close</button>
                </div>
            </div>
        </div>

     </div>
    
    <audio id="ringtone" loop><source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA" type="audio/wav"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyA2BfcS9qjzdT70cEcM4kMqDLfzInbMloY", authDomain: "textsms-6bc0b.firebaseapp.com", databaseURL: "https://textsms-6bc0b-default-rtdb.firebaseio.com", projectId: "textsms-6bc0b", storageBucket: "textsms-6bc0b.firebasestorage.app", messagingSenderId: "259023315417", appId: "1:259023315417:web:f335e5ffec03ef390179c8", measurementId: "G-6FV78CN212" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- CLOUDINARY CONFIG ---
        const cloudinaryConfig = { cloudName: "dzmo138qb", uploadPreset: "textsms" };
        
        // --- GLOBAL STATE ---
        let currentUser = null, currentChatPartner = null, currentCallData = null;
        let peerConnection, localStream, remoteStream, callAnswerListener = null;
        let totalNotifications = 0, currentView = 'loading-view', html5QrCode = null, scannerMode = null;
        let viewHistory = ['loading-view'];
        let imageFileToSend = null; 
        const stunServers = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' } ] };
        
        // --- UI ELEMENT SELECTORS ---
        const allViews = document.querySelectorAll('.view');
        const ringtone = document.getElementById('ringtone');
        
        window.currentListeners = { messages: null, messageRemovals: null };
        
        // --- REFACTORED NAVIGATION ---
        const _internalShowView = (viewId) => {
            currentView = viewId;
            allViews.forEach(v => v.style.display = 'none');
            const viewElement = document.getElementById(viewId);
            if(viewElement) {
                viewElement.style.display = 'flex';
            }
            if (history.state?.view !== viewId) {
                history.pushState({view: viewId}, '', `#${viewId}`);
            }
        };

        const showView = (viewId) => {
            if (viewId !== viewHistory[viewHistory.length - 1]) {
                viewHistory.push(viewId);
            }
            _internalShowView(viewId);
        };

        const goBack = () => {
            if (viewHistory.length > 1) {
                viewHistory.pop();
                const previousViewId = viewHistory[viewHistory.length - 1];
                _internalShowView(previousViewId);
            }
        };

        const showModal = (modalId, show = true) => { document.getElementById(modalId).style.display = show ? 'flex' : 'none'; };

        // --- UTILITY FUNCTIONS ---
        const generateJgId = () => `jg-${Math.floor(1000 + Math.random() * 9000)}`;
        const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');
        const escapeHTML = (str) => str.replace(/[&<>"']/g, (match) => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[match]));
        const linkify = (inputText) => { const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; return inputText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`); };
        
        function formatNumber(num) {
            if (isNaN(num)) return num;
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            }
            return num;
        }

        async function uploadImage(file) { if (!file) return null; if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) { alert("Cloudinary is not configured."); return null; } const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', cloudinaryConfig.uploadPreset); try { const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, { method: 'POST', body: formData }); const data = await response.json(); return data.secure_url ? data.secure_url : Promise.reject(data.error.message); } catch (error) { console.error('Cloudinary upload failed:', error); alert(`Image upload failed: ${error.message}`); return null; } }

        const getBlueBadgeIcon = (hasBadge) => {
            if (!hasBadge) return '';
            return `<svg class="blue-badge" viewBox="0 0 24 24" fill="#34B7F1"><path d="M22.5 12.5c0-1.28-.21-2.5-.6-3.63l-1.32.76c.28.89.42 1.83.42 2.87s-.14 1.98-.42 2.87l1.32.76c.39-1.13.6-2.35.6-3.63zm-2.48-5.32c-.52-.9-1.16-1.72-1.9-2.43l-1.13 1.13c.59.57 1.1 1.25 1.52 2.01l1.51-.71zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1.04 11.45l-2.83-2.83.71-.71 2.12 2.12 4.95-4.95.71.71-5.66 5.66zM4.98 7.18l1.51.71c.42-.76.93-1.44 1.52-2.01L6.88 4.75c-.74.71-1.38 1.53-1.9 2.43zM2.1 8.87l1.32-.76C3.02 9.22 2.9 10.16 2.9 11.1s.12 1.88.33 2.78l-1.32-.76C1.51 12.04 1.3 11.09 1.3 10.1s.21-1.94.6-2.87zm16.92 7.66l-1.51-.71c-.42.76-.93 1.44-1.52 2.01l1.13 1.13c.74-.71 1.38-1.53 1.9-2.43z"></path></svg>`;
        };

        async function calculateTotalLikes(userId) {
            let totalLikes = 0;
            const postsRef = db.ref('posts').orderByChild('authorUid').equalTo(userId);
            const snapshot = await postsRef.once('value');
            if (snapshot.exists()) {
                snapshot.forEach(postSnapshot => {
                    if (postSnapshot.hasChild('reactions/like')) {
                        totalLikes += postSnapshot.child('reactions/like').numChildren();
                    }
                });
            }
            return totalLikes;
        }
        
        // --- AUTHENTICATION & BACK BUTTON ---
        auth.onAuthStateChanged(async (user) => { 
            if (user) { 
                db.ref(`users/${user.uid}`).on('value', (snapshot) => { 
                    if (snapshot.exists()) { 
                        const wasNull = currentUser === null; 
                        currentUser = { uid: user.uid, ...snapshot.val() }; 
                        const headerImg = document.getElementById('header-profile-img');
                        if (headerImg) headerImg.src = currentUser.profileImageUrl;
                        if(wasNull) { 
                            initializeApp(); 
                        } 
                        if (currentView === 'loading-view' || currentView === 'auth-view') {
                             showView('main-view'); 
                        }
                    } else { 
                        showView('auth-view');
                        showModal('profile-setup-modal'); 
                    } 
                }); 
            } else { 
                currentUser = null; 
                showView('auth-view'); 
            } 
        });
        
        function setupBackButtonHandler() {
            window.onpopstate = (event) => {
                if (currentUser) {
                     if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop();
                    }
                    if (viewHistory.length > 1) {
                         goBack();
                    } else if (currentView !== 'main-view') {
                        showView('main-view');
                    } else {
                        showModal('exit-confirm-modal');
                    }
                }
            };
            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        }

        document.getElementById('exit-yes-btn').addEventListener('click', () => window.history.back());
        document.getElementById('exit-no-btn').addEventListener('click', () => showModal('exit-confirm-modal', false));
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => document.getElementById('login-error').textContent = err.message); });
        document.getElementById('signup-form').addEventListener('submit', (e) => { e.preventDefault(); auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value).then(cred => { currentUser = { uid: cred.user.uid, email: cred.user.email }; showModal('profile-setup-modal'); }).catch(err => document.getElementById('signup-error').textContent = err.message); });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); viewHistory = ['auth-view']; });
        document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'flex'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'flex'; });
        
        document.getElementById('save-profile-btn').addEventListener('click', async () => { 
            const name = document.getElementById('profile-name-input').value.trim(); 
            const gender = document.getElementById('profile-gender-select').value;
            const dob = document.getElementById('profile-dob-input').value;
            const imageFile = document.getElementById('profile-image-input').files[0]; 
            const coverFile = document.getElementById('profile-cover-input').files[0];
            if (!name || !gender || !dob) { return alert('Name, Gender, and Date of Birth are required.'); }
            const btn = document.getElementById('save-profile-btn'); 
            btn.disabled = true; btn.textContent = "Saving..."; 
            const imageUrl = await uploadImage(imageFile);
            const coverUrl = await uploadImage(coverFile);
            const profileData = { name, gender, dob, profileImageUrl: imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`, coverImageUrl: coverUrl || '', jgId: generateJgId(), email: currentUser.email, contacts: {}, blocked: {}, followers: {}, following: {}, hasBlueBadge: false, coins: 0.00 }; 
            db.ref(`users/${currentUser.uid}`).set(profileData).then(() => { showModal('profile-setup-modal', false); btn.disabled = false; btn.textContent = "Save Profile"; }); 
        });
        
        function initializeApp() {
            listenForContacts();
            listenForFriendRequests();
            listenForIncomingCalls();
            listenForUnreadMessages();
            renderCallLogs();
            setupBackButtonHandler();
        }

        function detachAllListeners() { 
            if (window.currentListeners.messages) { 
                db.ref(window.currentListeners.messages.path).off('child_added', window.currentListeners.messages.callback);
            }
            if (window.currentListeners.messageRemovals) { 
                db.ref(window.currentListeners.messageRemovals.path).off('child_removed', window.currentListeners.messageRemovals.callback); 
            }
            window.currentListeners = { messages: null, messageRemovals: null };
        }

        // --- NAVIGATION ---
        document.getElementById('menu-btn').addEventListener('click', () => openProfileView());
        document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
        document.getElementById('notification-btn').addEventListener('click', () => showView('notifications-view'));
        document.getElementById('close-add-friend-modal-btn').addEventListener('click', () => showModal('add-friend-modal', false));
        document.getElementById('chat-header-info').addEventListener('click', () => { if (currentChatPartner) openUserProfileView(currentChatPartner.uid); });
        document.getElementById('chat-header-img').addEventListener('click', () => { if (currentChatPartner) openUserProfileView(currentChatPartner.uid); });
        document.getElementById('close-post-image-view-btn').addEventListener('click', () => showModal('post-image-view-modal', false));


        // --- QR Code & Scanner ---
        document.getElementById('show-qr-btn').addEventListener('click', () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: currentUser.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = currentUser.jgId; showModal('qr-code-modal'); });
        document.getElementById('close-qr-modal-btn').addEventListener('click', () => showModal('qr-code-modal', false));
        function startScanner(mode) { scannerMode = mode; showView('qr-scanner-view'); html5QrCode = new Html5Qrcode("qr-reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess).catch(err => alert("QR Code scanning failed. Please grant camera permissions.")); }
        document.getElementById('scan-qr-btn').addEventListener('click', () => startScanner('addUser'));
        function onScanSuccess(decodedText, decodedResult) { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop(); } if (scannerMode === 'addUser') { showModal('add-friend-modal', false); sendFriendRequestById(decodedText); } }

        // --- FRIEND REQUESTS & CONTACTS ---
        function sendFriendRequestById(friendId) { if (!friendId) return; db.ref('users').orderByChild('jgId').equalTo(friendId).once('value', snapshot => { if (snapshot.exists()) { const friendUid = Object.keys(snapshot.val())[0]; if(friendUid === currentUser.uid) { alert("You can't add yourself."); goBack(); return; } db.ref(`users/${friendUid}`).once('value', friendSnap => { const friendData = friendSnap.val(); const request = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: 'incoming' }; db.ref(`requests/${friendUid}/${currentUser.uid}`).set(request).then(() => { alert('Friend request sent!'); goBack(); }); }); } else { alert('User not found.'); goBack(); } }); }
        document.getElementById('send-friend-request-btn').addEventListener('click', () => { const friendId = document.getElementById('add-friend-id-input').value.trim(); sendFriendRequestById(friendId); showModal('add-friend-modal', false); document.getElementById('add-friend-id-input').value = ''; });
        
        function updateNotificationBadge() { const badge = document.getElementById('notification-badge'); badge.textContent = totalNotifications; badge.style.display = totalNotifications > 0 ? 'block' : 'none'; }
        
        function listenForFriendRequests() { db.ref(`requests/${currentUser.uid}`).on('value', snapshot => { const list = document.getElementById('friend-requests-list'); list.innerHTML = ''; let incomingRequestCount = 0; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const request = childSnapshot.val(); const fromUid = childSnapshot.key; if (currentUser.blocked && currentUser.blocked[fromUid]) return; const div = document.createElement('div'); div.className = 'list-item'; div.style.cursor = 'default'; const type = request.type || 'incoming'; switch (type) { case 'incoming': incomingRequestCount++; div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Wants to be your friend</div></div><div class="list-item-actions"><button onclick="handleFriendRequest('${fromUid}', true)">Accept</button><button class="reject" onclick="handleFriendRequest('${fromUid}', false)">Reject</button></div>`; break; case 'accepted': div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Accepted your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`; break; case 'rejected': div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Declined your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`; break; } if (div.innerHTML) { list.appendChild(div); } }); } if (list.childElementCount === 0) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No new friend requests.</p>'; } 
            totalNotifications = incomingRequestCount;
            updateNotificationBadge();
        }); }
        window.dismissNotification = (type, notificationId) => { db.ref(`${type}/${currentUser.uid}/${notificationId}`).remove(); };
        window.handleFriendRequest = (fromUid, accepted) => { db.ref(`requests/${currentUser.uid}/${fromUid}`).remove(); const notification = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: accepted ? 'accepted' : 'rejected' }; db.ref(`requests/${fromUid}/${currentUser.uid}`).set(notification); if (accepted) { db.ref(`users/${currentUser.uid}/contacts/${fromUid}`).set(true); db.ref(`users/${fromUid}/contacts/${currentUser.uid}`).set(true); } };
        function listenForContacts() { db.ref(`users/${currentUser.uid}/contacts`).on('value', snapshot => { const list = document.getElementById('contact-list'); list.innerHTML = ''; if(snapshot.exists()){ snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { if (userSnap.exists()){ const contact = userSnap.val(); const div = document.createElement('div'); div.className = 'list-item'; div.onclick = () => openChat(childSnapshot.key, contact); div.innerHTML = `<img src="${contact.profileImageUrl}" class="list-item-profile-img" alt="C"><div class="list-item-details"><div class="list-item-name">${contact.name}</div><div class="list-item-subtext" id="unread-count-${getChatId(currentUser.uid, childSnapshot.key)}">Click to open chat</div></div>`; list.appendChild(div); } }); }); } else { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">Add friends to start chatting!</p>'; } }); }
        
        // --- CHAT ---
        async function openChat(partnerUid, partnerData) { if (currentUser.blocked && currentUser.blocked[partnerUid]) return alert(`This user is blocked. Unblock them from your profile to interact.`); detachAllListeners(); currentChatPartner = { uid: partnerUid, ...partnerData }; const chatId = getChatId(currentUser.uid, partnerUid); document.getElementById('chat-input-container').style.display = 'flex'; document.getElementById('chat-input').placeholder = 'Message'; document.getElementById('voice-call-btn').style.display = 'flex'; document.getElementById('video-call-btn').style.display = 'flex'; document.getElementById('chat-more-btn').style.display = 'flex'; document.getElementById('chat-attach-btn').style.display = 'flex'; document.getElementById('chat-header-subtext').textContent = ''; document.getElementById('chat-header-img').src = partnerData.profileImageUrl; document.getElementById('chat-header-name').innerHTML = `${escapeHTML(partnerData.name)} ${getBlueBadgeIcon(partnerData.hasBlueBadge)}`; document.getElementById('chat-messages').innerHTML = ''; db.ref(`unreadCounts/${currentUser.uid}/${chatId}`).set(0); const messagesRef = db.ref(`messages/${chatId}`).limitToLast(50); const messageCallback = snapshot => { const msg = snapshot.val(); const msgId = snapshot.key; const div = document.createElement('div'); div.id = `msg-${msgId}`; let contentHTML = ''; if (msg.type === 'image') { contentHTML = `<img src="${msg.imageUrl}" alt="Sent image" onclick="viewPostImage('${msg.imageUrl}')">`; } else { contentHTML = linkify(escapeHTML(msg.text || '')); } div.innerHTML = contentHTML; div.className = 'message-bubble ' + (msg.sender === currentUser.uid ? 'message-sent' : 'message-received'); if(msg.sender === currentUser.uid){ div.onclick = () => confirmDeleteMessage(chatId, msgId); } document.getElementById('chat-messages').appendChild(div); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight; }; const messageRemovalCallback = snapshot => { const msgElement = document.getElementById(`msg-${snapshot.key}`); if (msgElement) msgElement.remove(); }; messagesRef.on('child_added', messageCallback); messagesRef.on('child_removed', messageRemovalCallback); window.currentListeners.messages = { path: `messages/${chatId}`, event: 'child_added', callback: messageCallback }; window.currentListeners.messageRemovals = { path: `messages/${chatId}`, callback: messageRemovalCallback }; showView('chat-view'); }
        document.getElementById('chat-attach-btn').addEventListener('click', () => { document.getElementById('chat-image-input').click(); });
        document.getElementById('chat-image-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; imageFileToSend = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('image-preview-display').innerHTML = `<img src="${event.target.result}" alt="Preview">`; showModal('image-preview-modal'); }; reader.readAsDataURL(file); e.target.value = ''; });
        document.getElementById('cancel-image-send-btn').addEventListener('click', () => { imageFileToSend = null; showModal('image-preview-modal', false); });
        document.getElementById('confirm-image-send-btn').addEventListener('click', async () => { if (!imageFileToSend || !currentChatPartner) return; const button = document.getElementById('confirm-image-send-btn'); button.disabled = true; button.textContent = "Sending..."; const imageUrl = await uploadImage(imageFileToSend); if (imageUrl) { const messageData = { type: 'image', imageUrl: imageUrl, sender: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }; if (currentChatPartner) { const chatId = getChatId(currentUser.uid, currentChatPartner.uid); db.ref(`messages/${chatId}`).push(messageData); db.ref(`unreadCounts/${currentChatPartner.uid}/${chatId}`).transaction(count => (count || 0) + 1); } } imageFileToSend = null; showModal('image-preview-modal', false); button.disabled = false; button.textContent = "Send"; });
        window.confirmDeleteMessage = (chatId, messageId) => { if (confirm("Are you sure you want to delete this message?")) { db.ref(`messages/${chatId}/${messageId}`).remove(); } };
        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        function sendMessage() { const input = document.getElementById('chat-input'); const text = input.value.trim(); if (!text) return; if (currentChatPartner) { if (currentChatPartner.blocked && currentChatPartner.blocked[currentUser.uid]) return alert("You have been blocked by this user."); const chatId = getChatId(currentUser.uid, currentChatPartner.uid); db.ref(`messages/${chatId}`).push({ type: 'text', text: text, sender: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }); db.ref(`unreadCounts/${currentChatPartner.uid}/${chatId}`).transaction(count => (count || 0) + 1); } input.value = ''; input.style.height = 'auto'; }
        function listenForUnreadMessages() { db.ref(`unreadCounts/${currentUser.uid}`).on('value', snapshot => { let totalUnread = 0; snapshot.forEach(chatSnap => { const count = chatSnap.val(); totalUnread += count; const unreadElem = document.getElementById(`unread-count-${chatSnap.key}`); if (unreadElem) unreadElem.textContent = count > 0 ? `${count} new message${count > 1 ? 's' : ''}` : 'Click to open chat'; }); }); }
        window.viewPostImage = (imageUrl) => { document.getElementById('post-image-view-src').src = imageUrl; showModal('post-image-view-modal'); };
        
        // --- CALLS ---
        document.getElementById('video-call-btn').addEventListener('click', () => startCall(true));
        document.getElementById('voice-call-btn').addEventListener('click', () => startCall(false));
        async function startCall(isVideo) { if (!currentChatPartner || (currentUser.blocked && currentUser.blocked[currentChatPartner.uid])) return alert(`You cannot call a blocked user.`); currentCallData = { id: db.ref('calls').push().key, isVideo, caller: { uid: currentUser.uid, ...currentUser }, calleeId: currentChatPartner.uid }; try { localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }); if (isVideo) { document.getElementById('local-video').srcObject = localStream; } peerConnection = new RTCPeerConnection(stunServers); localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); peerConnection.onicecandidate = e => { if (e.candidate) db.ref(`iceCandidates/${currentCallData.id}/caller`).push(e.candidate.toJSON()); }; peerConnection.ontrack = e => { remoteStream = e.streams[0]; document.getElementById(currentCallData.isVideo ? 'remote-video' : 'remote-audio').srcObject = remoteStream; }; const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); await db.ref(`calls/${currentCallData.calleeId}`).set({ ...currentCallData, offer: { type: offer.type, sdp: offer.sdp }}); listenForCallAnswer(currentCallData.id); showCallUI(isVideo, 'Calling...'); } catch (error) { console.error("Error starting call: ", error); alert("Could not start call. Check permissions."); cleanupCall(); } }
        function listenForCallAnswer(callId) { const callRefPath = `calls/${currentCallData.calleeId}`; const callback = async (snapshot) => { const data = snapshot.val(); if (data && data.answer && peerConnection && peerConnection.remoteDescription === null) { try { await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); listenForRemoteIceCandidates(callId, 'callee'); updateCallStatus('Connected'); } catch(e) { console.error("Error setting remote description from answer: ", e); endCall(); } } else if (!data) { endCall(); } }; db.ref(callRefPath).on('value', callback); callAnswerListener = { path: callRefPath, callback: callback }; }
        function listenForIncomingCalls() { db.ref(`calls/${currentUser.uid}`).on('value', async snapshot => { const callData = snapshot.val(); if(callData && !currentCallData) { if (currentUser.blocked && currentUser.blocked[callData.caller.uid]) { db.ref(`calls/${currentUser.uid}`).remove(); return; } currentCallData = callData; document.getElementById('incoming-caller-info').querySelector('.profile-img').src = callData.caller.profileImageUrl; document.getElementById('incoming-caller-info').querySelector('.name').textContent = callData.caller.name; showModal('incoming-call-modal'); ringtone.play(); } }); }
        document.getElementById('accept-call-btn').addEventListener('click', async () => { showModal('incoming-call-modal', false); ringtone.pause(); ringtone.currentTime = 0; const { isVideo, id: callId, offer } = currentCallData; try { localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }); if (isVideo) { document.getElementById('local-video').srcObject = localStream; } peerConnection = new RTCPeerConnection(stunServers); localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); peerConnection.onicecandidate = e => { if (e.candidate) db.ref(`iceCandidates/${callId}/callee`).push(e.candidate.toJSON()); }; peerConnection.ontrack = e => { remoteStream = e.streams[0]; document.getElementById(currentCallData.isVideo ? 'remote-video' : 'remote-audio').srcObject = remoteStream; }; await peerConnection.setRemoteDescription(new RTCSessionDescription(offer)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); await db.ref(`calls/${currentUser.uid}`).update({ answer: { type: answer.type, sdp: answer.sdp }}); listenForRemoteIceCandidates(callId, 'caller'); showCallUI(isVideo, 'Connected'); } catch(error) { console.error("Error accepting call:", error); alert("Could not accept call."); cleanupCall(); } });
        document.getElementById('reject-call-btn').addEventListener('click', () => { showModal('incoming-call-modal', false); ringtone.pause(); ringtone.currentTime = 0; db.ref(`calls/${currentUser.uid}`).remove(); logCall('rejected'); currentCallData = null; });
        function listenForRemoteIceCandidates(callId, role) { db.ref(`iceCandidates/${callId}/${role}`).on('child_added', s => { if (s.exists() && peerConnection) peerConnection.addIceCandidate(new RTCIceCandidate(s.val())); }); }
        function showCallUI(isVideo, status) { const viewId = isVideo ? 'video-call-view' : 'voice-call-view'; const callerInfo = document.getElementById(isVideo ? 'video-caller-info' : 'voice-caller-info'); const contact = currentCallData.caller.uid === currentUser.uid ? currentChatPartner : currentCallData.caller; callerInfo.querySelector('.profile-img').src = contact.profileImageUrl; callerInfo.querySelector('.name').textContent = contact.name; callerInfo.querySelector('.status').textContent = status; showView(viewId); }
        function updateCallStatus(status) { if (!currentCallData) return; const viewId = currentCallData.isVideo ? 'video-call-view' : 'voice-call-view'; const statusElem = document.querySelector(`#${viewId} .status`); if(statusElem) statusElem.textContent = status; }
        document.getElementById('end-video-call-btn').addEventListener('click', endCall);
        document.getElementById('end-voice-call-btn').addEventListener('click', endCall);
        function endCall() { logCall('ended'); cleanupCall(); }
        function cleanupCall() { if (callAnswerListener) { db.ref(callAnswerListener.path).off('value', callAnswerListener.callback); callAnswerListener = null; } if (peerConnection) { peerConnection.close(); peerConnection = null; } if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; } document.getElementById('local-video').srcObject = null; document.getElementById('remote-video').srcObject = null; document.getElementById('remote-audio').srcObject = null; if (currentCallData) { const otherUserId = currentCallData.caller.uid === currentUser.uid ? currentCallData.calleeId : currentCallData.caller.uid; db.ref(`calls/${otherUserId}`).remove(); db.ref(`calls/${currentUser.uid}`).remove(); db.ref(`iceCandidates/${currentCallData.id}`).remove(); } currentCallData = null; if (currentView !== 'main-view') { showView('main-view'); } }
        function logCall(status) { if (!currentCallData) return; const partner = currentCallData.caller.uid === currentUser.uid ? currentChatPartner : currentCallData.caller; if(!partner) return; db.ref(`callLogs/${currentUser.uid}`).push({ partnerName: partner.name, partnerProfileImageUrl: partner.profileImageUrl, type: currentCallData.isVideo ? 'video' : 'voice', status, timestamp: firebase.database.ServerValue.TIMESTAMP }); }
        function renderCallLogs() { const list = document.getElementById('call-logs-list'); db.ref(`callLogs/${currentUser.uid}`).orderByChild('timestamp').limitToLast(30).on('value', snapshot => { list.innerHTML = ''; if (!snapshot.exists()) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No recent calls.</p>'; return; } const logs = []; snapshot.forEach(child => logs.push(child.val())); logs.reverse().forEach(log => { const div = document.createElement('div'); div.className = 'list-item'; div.style.cursor = 'default'; div.innerHTML = `<img src="${log.partnerProfileImageUrl}" class="list-item-profile-img" alt="P"> <div class="list-item-details"> <div class="list-item-name">${log.partnerName} (${log.type})</div> <div class="list-item-subtext">${log.status} - ${new Date(log.timestamp).toLocaleString()}</div> </div>`; list.appendChild(div); }); }); }
        
        // --- PROFILE & BLOCKING ---
        async function openProfileView() { const display = document.getElementById('profile-info-display'); display.querySelector('.profile-cover-photo').src = currentUser.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; display.querySelector('.profile-img').src = currentUser.profileImageUrl; display.querySelector('.name').innerHTML = `${escapeHTML(currentUser.name)} ${getBlueBadgeIcon(currentUser.hasBlueBadge)}`; display.querySelector('.jgId').textContent = `ID: ${currentUser.jgId}`; document.getElementById('profile-friends-count').textContent = Object.keys(currentUser.contacts || {}).length; document.getElementById('profile-followers-count').textContent = Object.keys(currentUser.followers || {}).length; document.getElementById('profile-likes-count').textContent = '...'; calculateTotalLikes(currentUser.uid).then(totalLikes => { document.getElementById('profile-likes-count').textContent = totalLikes; }); document.getElementById('edit-profile-name').value = currentUser.name; document.getElementById('profile-options').style.display = 'flex'; document.getElementById('profile-edit-form').style.display = 'none'; renderBlockedUsers(); showView('profile-view'); }
        document.getElementById('request-badge-btn').addEventListener('click', () => { const requestRef = db.ref(`badgeRequests/${currentUser.uid}`); requestRef.once('value', snapshot => { if (snapshot.exists()) { alert('You have already submitted a badge request.'); } else { requestRef.set({ name: currentUser.name, jgId: currentUser.jgId, requestedAt: firebase.database.ServerValue.TIMESTAMP, status: 'pending' }).then(() => { alert('Your badge request has been submitted for review.'); }); } }); });
        document.getElementById('edit-profile-btn').addEventListener('click', () => { document.getElementById('profile-options').style.display = 'none'; document.getElementById('profile-edit-form').style.display = 'flex'; });
        document.getElementById('save-profile-changes-btn').addEventListener('click', async () => { const button = document.getElementById('save-profile-changes-btn'); button.disabled = true; button.textContent = "Saving..."; const newName = document.getElementById('edit-profile-name').value.trim(); const imageFile = document.getElementById('edit-profile-image').files[0]; const coverFile = document.getElementById('edit-profile-cover').files[0]; let updates = { name: newName }; if(imageFile){ const newImageUrl = await uploadImage(imageFile); if(newImageUrl) updates.profileImageUrl = newImageUrl; } if(coverFile){ const newCoverUrl = await uploadImage(coverFile); if(newCoverUrl) updates.coverImageUrl = newCoverUrl; } db.ref(`users/${currentUser.uid}`).update(updates).then(() => { button.disabled = false; button.textContent = "Save Changes"; openProfileView(); }); });
        document.getElementById('chat-more-btn').addEventListener('click', (e) => { e.stopPropagation(); if (!currentChatPartner) return; document.getElementById('chat-options-menu').style.display = document.getElementById('chat-options-menu').style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', () => { document.getElementById('chat-options-menu').style.display = 'none'; });
        document.getElementById('view-profile-btn').addEventListener('click', () => { if (!currentChatPartner) return; openUserProfileView(currentChatPartner.uid); document.getElementById('chat-options-menu').style.display = 'none'; });
        document.getElementById('delete-friend-btn').addEventListener('click', () => { if (!currentChatPartner) return; if (confirm(`Are you sure you want to remove ${currentChatPartner.name} from your contacts?`)) { const partnerUid = currentChatPartner.uid; db.ref(`users/${currentUser.uid}/contacts/${partnerUid}`).remove(); db.ref(`users/${partnerUid}/contacts/${currentUser.uid}`).remove(); alert(`${currentChatPartner.name} has been removed from your contacts.`); goBack() } document.getElementById('chat-options-menu').style.display = 'none'; });
        document.getElementById('block-user-btn').addEventListener('click', () => { if (!currentChatPartner) return; if (confirm(`Are you sure you want to block ${currentChatPartner.name}? They will be removed from your contacts and you won't be able to interact.`)) { blockUser(currentChatPartner.uid); } document.getElementById('chat-options-menu').style.display = 'none'; });
        function blockUser(uidToBlock) { db.ref(`users/${currentUser.uid}/blocked/${uidToBlock}`).set(true).then(() => { alert('User blocked.'); db.ref(`users/${currentUser.uid}/contacts/${uidToBlock}`).remove(); goBack(); }); }
        window.unblockUser = (uidToUnblock) => { db.ref(`users/${currentUser.uid}/blocked/${uidToUnblock}`).remove().then(() => { alert('User unblocked.'); renderBlockedUsers(); }); }
        function renderBlockedUsers() { const list = document.getElementById('blocked-users-list'); list.innerHTML = ''; db.ref(`users/${currentUser.uid}/blocked`).once('value', snapshot => { if (!snapshot.exists()) { list.innerHTML = '<p style="font-size:12px; text-align:center; color: #667781;">No users blocked.</p>'; return; } snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { if (userSnap.exists()) { const user = userSnap.val(); const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<img src="${user.profileImageUrl}" class="list-item-profile-img" alt="U"><div class="list-item-details"><div class="list-item-name">${user.name}</div></div><div class="list-item-actions"><button onclick="unblockUser('${childSnapshot.key}')">Unblock</button></div>`; list.appendChild(item); } }); }); }); }
        
        // --- USER PROFILE VIEW ---
        async function openUserProfileView(userId) { if (!userId) return; const userSnap = await db.ref(`users/${userId}`).once('value'); if (!userSnap.exists()) { alert("User not found."); return; } const userData = userSnap.val(); document.getElementById('user-profile-page-title').textContent = userData.name; const infoDisplay = document.getElementById('user-profile-info-display'); infoDisplay.querySelector('.profile-cover-photo').src = userData.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; infoDisplay.querySelector('.profile-img').src = userData.profileImageUrl; infoDisplay.querySelector('.name').innerHTML = `${escapeHTML(userData.name)} ${getBlueBadgeIcon(userData.hasBlueBadge)}`; document.getElementById('user-profile-friends-count').textContent = Object.keys(userData.contacts || {}).length; document.getElementById('user-profile-followers-count').textContent = Object.keys(userData.followers || {}).length; document.getElementById('user-profile-likes-count').textContent = '...'; calculateTotalLikes(userId).then(totalLikes => { document.getElementById('user-profile-likes-count').textContent = totalLikes; }); const actionsContainer = document.getElementById('user-profile-actions'); if (userId === currentUser.uid) { actionsContainer.style.display = 'none'; } else { actionsContainer.style.display = 'flex'; const followBtn = document.getElementById('follow-user-btn'); const isFollowing = currentUser.following && currentUser.following[userId]; followBtn.innerHTML = isFollowing ? `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg> <span>Following</span>` : `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-4H7v-2h4V7h2v4h4v2h-4v4h-2z"></path></svg> <span>Follow</span>`; followBtn.onclick = () => toggleFollow(userId); } document.getElementById('user-profile-show-qr-btn').onclick = () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: userData.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = userData.jgId; showModal('qr-code-modal'); }; const postsList = document.getElementById('user-profile-posts-list'); postsList.innerHTML = '<p style="text-align:center; padding: 20px;">Posts can be viewed in Kotha App.</p>'; showView('user-profile-view'); }
        function toggleFollow(userIdToFollow) { const followingRef = db.ref(`users/${currentUser.uid}/following/${userIdToFollow}`); const followerRef = db.ref(`users/${userIdToFollow}/followers/${currentUser.uid}`); followingRef.once('value', snapshot => { if (snapshot.exists()) { followingRef.remove(); followerRef.remove(); } else { followingRef.set(true); followerRef.set(true); } openUserProfileView(userIdToFollow); }); }
    </script>
</body>
</html>